{% raw %}name: CI

on:
  pull_request:
    paths:
      - '.github/workflows/ci.yml'
      - '.roave-backward-compatibility-check.xml'
      - 'src/**'
      - 'tests/**'
      - 'composer.json'
      - '.phive/phars.xml'
      - '.php-cs-fixer.dist.php'
      - 'infection.json5.dist'
      - 'phpstan.neon.dist'
      - 'phpunit.dist.xml'
      - 'rector.php'
      - 'tools/**'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/ci.yml'
      - '.roave-backward-compatibility-check.xml'
      - 'src/**'
      - 'tests/**'
      - 'composer.json'
      - '.phive/phars.xml'
      - '.php-cs-fixer.dist.php'
      - 'infection.json5.dist'
      - 'phpstan.neon.dist'
      - 'phpunit.dist.xml'
      - 'rector.php'
      - 'tools/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  dependency-validation:
    name: Dependency Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, curl, dom, iconv, json, mbstring, openssl, phar, tokenizer
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Validate composer.json
        run: composer validate --strict

      - name: Ensure dependencies can be installed
        run: composer install --no-interaction --no-progress --ansi --dry-run

  static-analysis:
    name: Static Analysis
    needs:
      - dependency-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, ctype, curl, dom, iconv, json, libxml, mbstring, phar, tokenizer, xml, xmlwriter
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: composer update --no-interaction --no-progress --ansi

      - name: Cache PHPStan dependencies
        uses: actions/cache@v5
        with:
          path: tools/.phpstan/vendor
          key: ${{ runner.os }}-phpstan-tools-${{ hashFiles('tools/.phpstan/composer.lock') }}

      - name: Install PHPStan dependencies
        run: composer --working-dir=tools/.phpstan install --no-interaction --no-progress --ansi
      - name: Setup Problem Matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"

      - name: Static Analysis
        run: tools/phpstan --ansi analyse

  unit-tests:
    name: Unit Tests (PHP ${{ matrix.php }}, ${{ matrix.dependencies }})
    needs:
      - dependency-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      PHP_INI_VALUES: memory_limit=-1, zend.assertions=1, error_reporting=-1, log_errors_max_len=0, display_errors=On

    strategy:
      fail-fast: false
      matrix:
        php:
          - "8.4"
          - "8.5"
        dependencies:
          - "lowest"
          - "highest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: none, ctype, curl, dom, iconv, json, libxml, mbstring, openssl, phar, tokenizer, xml, xmlwriter, pcntl
          ini-values: ${{ env.PHP_INI_VALUES }}
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: |
          if [ "${{ matrix.dependencies }}" = "lowest" ]; then
            composer update --prefer-lowest --prefer-stable --no-interaction --no-progress --ansi
          else
            composer update --no-interaction --no-progress --ansi
          fi
      - name: Setup Problem Matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"
          echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

      - name: Run PHPUnit
        run: tools/phpunit --colors=always --testdox

  lint:
    name: Lint
    needs:
      - dependency-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, curl, dom, iconv, json, mbstring, phar, tokenizer
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: composer update --no-interaction --no-progress --ansi

      - name: Cache Rector dependencies
        uses: actions/cache@v5
        with:
          path: tools/.rector/vendor
          key: ${{ runner.os }}-rector-tools-${{ hashFiles('tools/.rector/composer.lock') }}

      - name: Install Rector dependencies
        run: composer --working-dir=tools/.rector install --no-interaction --no-progress --ansi
      - name: Run linter suite
        run: |
          tools/rector --ansi --dry-run
          tools/php-cs-fixer check --ansi --diff --verbose
          tools/composer-normalize --ansi --dry-run

  code-coverage:
    name: Code Coverage
    needs:
      - unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      PHP_INI_VALUES: memory_limit=-1, zend.assertions=1, error_reporting=-1, log_errors_max_len=0, display_errors=On

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, ctype, curl, dom, iconv, json, libxml, mbstring, openssl, phar, tokenizer, xml, xmlwriter, pcntl
          ini-values: ${{ env.PHP_INI_VALUES }}
          coverage: xdebug
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: composer update --no-interaction --no-progress --ansi
      - name: Cache PHPUnit static analysis cache
        uses: actions/cache@v5
        with:
          path: .phpunit.cache/code-coverage
          key: ${{ runner.os }}-phpunit-code-coverage-${{ github.ref }}-
          restore-keys: |
            ${{ runner.os }}-phpunit-code-coverage-${{ github.ref }}-

      - name: Warm PHPUnit static analysis cache
        run: tools/phpunit --warm-coverage-cache

      - name: Collect code coverage with PHPUnit
        run: tools/phpunit --log-junit build/test-results.xml --coverage-clover build/code-coverage.xml

      # - name: Upload test results to Codecov.io
      #   if: ${{ !cancelled() }}
      #   uses: codecov/codecov-action@v5
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     report_type: test_results
      #     disable_search: true
      #     files: ./build/test-results.xml

      # - name: Upload code coverage data to Codecov.io
      #   if: ${{ !cancelled() }}
      #   uses: codecov/codecov-action@v5
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     report_type: coverage
      #     disable_search: true
      #     files: ./build/code-coverage.xml

  bc-check:
    name: Backward Compatibility Check
    needs:
      - unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      # Workaround for https://github.com/Nyholm/roave-bc-check-docker/issues/32
      # and https://github.com/actions/runner/issues/2033.
      # Remove this step once the upstream Docker action/runner no longer requires
      # writing safe.directory into $HOME/.gitconfig for container actions.
      - name: "Workaround: Configure Git safe.directory for roave-bc-check Docker action"
        run: |
          mkdir -p /home/runner/work/_temp/_github_home
          printf "[safe]\n\tdirectory = /github/workspace\n" > /home/runner/work/_temp/_github_home/.gitconfig

      - name: Check whether repository has tags
        id: check-tags
        shell: bash
        run: |
          if git tag --list | grep -q .; then
            echo "has_tags=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tags=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Roave BC Check
        if: ${{ steps.check-tags.outputs.has_tags == 'true' }}
        uses: docker://nyholm/roave-bc-check-ga

      - name: Skip Roave BC Check (no tags found)
        if: ${{ steps.check-tags.outputs.has_tags != 'true' }}
        run: echo "Skipping BC check because no git tags were found."
{% endraw %}
